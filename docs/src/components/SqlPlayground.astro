---
interface Query {
  label: string;
  sql: string;
  result: { columns: string[]; rows: string[][] };
}

const queries: Query[] = [
  {
    label: "SELECT — Basic Query",
    sql: `SELECT name, email, created_at
FROM users
WHERE status = 'active'
ORDER BY created_at DESC
LIMIT 5;`,
    result: {
      columns: ["name", "email", "created_at"],
      rows: [
        ["Alice Chen", "alice@example.com", "2025-03-15 09:22:01"],
        ["Bob Smith", "bob@example.com", "2025-03-14 14:05:33"],
        ["Carol Wu", "carol@example.com", "2025-03-14 08:47:19"],
        ["Dave Park", "dave@example.com", "2025-03-13 22:11:45"],
        ["Eve Jones", "eve@example.com", "2025-03-12 16:33:08"],
      ]
    }
  },
  {
    label: "INSERT — Immutable Fact",
    sql: `INSERT INTO transactions (id, account, amount, currency)
VALUES ('txn_001', 'acc_alice', 250.00, 'USD');

-- Every write becomes an immutable fact with:
--   commit_ts  = auto-assigned system timestamp
--   valid_from = now (or specified)
--   valid_to   = infinity`,
    result: {
      columns: ["result"],
      rows: [["1 row inserted (commit_ts: 1042)"]]
    }
  },
  {
    label: "AS OF — Time Travel",
    sql: `-- Read the database as it was at commit 500
SELECT account, balance
FROM accounts
AS OF 500
WHERE account = 'acc_alice';`,
    result: {
      columns: ["account", "balance"],
      rows: [["acc_alice", "1,500.00"]]
    }
  },
  {
    label: "VALID AT — Bitemporal Query",
    sql: `-- What was the policy rate valid on 2024-06-15?
SELECT policy_id, rate, valid_from, valid_to
FROM insurance_policies
VALID AT 1718409600
WHERE policy_id = 'POL-2024-001';`,
    result: {
      columns: ["policy_id", "rate", "valid_from", "valid_to"],
      rows: [["POL-2024-001", "4.25", "1704067200", "1735689600"]]
    }
  },
  {
    label: "JOIN — Cross-Table Query",
    sql: `SELECT u.name, COUNT(o.id) as order_count,
       SUM(o.total) as total_spent
FROM users u
JOIN orders o ON u.id = o.user_id
GROUP BY u.name
HAVING total_spent > 100
ORDER BY total_spent DESC;`,
    result: {
      columns: ["name", "order_count", "total_spent"],
      rows: [
        ["Alice Chen", "12", "2,450.00"],
        ["Bob Smith", "8", "1,823.50"],
        ["Carol Wu", "5", "967.25"],
      ]
    }
  },
  {
    label: "EXPLAIN — Query Plan",
    sql: `EXPLAIN ANALYZE
SELECT * FROM orders
WHERE user_id = 'u_alice'
  AND status = 'shipped';`,
    result: {
      columns: ["plan"],
      rows: [
        ["Filter { predicate: status = 'shipped' }"],
        ["  └─ PointLookup { key: 'u_alice', cost: 1.00 }"],
        [""],
        ["execution_time_us: 42"],
        ["rows_returned: 3"],
        ["bloom_filter_hits: 1"],
        ["cache_hits: 2"],
      ]
    }
  }
];

// Build-time SQL syntax highlighter
function highlightSQL(sql: string): string {
  const keywords = new Set([
    'SELECT','FROM','WHERE','INSERT','INTO','VALUES','UPDATE','SET','DELETE',
    'CREATE','TABLE','DROP','ALTER','ADD','JOIN','ON','LEFT','RIGHT','INNER',
    'OUTER','CROSS','GROUP','BY','ORDER','ASC','DESC','LIMIT','OFFSET',
    'HAVING','AND','OR','NOT','IN','IS','NULL','AS','OF','VALID','AT',
    'EXPLAIN','ANALYZE','COUNT','SUM','AVG','MIN','MAX','DISTINCT',
    'BETWEEN','LIKE','CASE','WHEN','THEN','ELSE','END','UNION','ALL',
    'EXISTS','WITH','PRIMARY','KEY','TEXT','INTEGER','REAL','BLOB','BOOL',
  ]);

  const tokens: { type: string; text: string }[] = [];
  let i = 0;
  while (i < sql.length) {
    if (sql[i] === '-' && sql[i + 1] === '-') {
      let end = sql.indexOf('\n', i);
      if (end === -1) end = sql.length;
      tokens.push({ type: 'comment', text: sql.slice(i, end) });
      i = end;
    } else if (sql[i] === "'") {
      let end = i + 1;
      while (end < sql.length && sql[end] !== "'") end++;
      tokens.push({ type: 'string', text: sql.slice(i, end + 1) });
      i = end + 1;
    } else if (/[a-zA-Z_]/.test(sql[i])) {
      let end = i;
      while (end < sql.length && /[a-zA-Z_0-9]/.test(sql[end])) end++;
      const word = sql.slice(i, end);
      tokens.push({
        type: keywords.has(word.toUpperCase()) ? 'keyword' : 'ident',
        text: word,
      });
      i = end;
    } else if (/[0-9]/.test(sql[i])) {
      let end = i;
      while (end < sql.length && /[0-9.,]/.test(sql[end])) end++;
      tokens.push({ type: 'number', text: sql.slice(i, end) });
      i = end;
    } else {
      tokens.push({ type: 'other', text: sql[i] });
      i++;
    }
  }

  return tokens
    .map((t) => {
      const esc = t.text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      switch (t.type) {
        case 'keyword': return `<span class="sql-kw">${esc}</span>`;
        case 'string':  return `<span class="sql-str">${esc}</span>`;
        case 'number':  return `<span class="sql-num">${esc}</span>`;
        case 'comment': return `<span class="sql-cmt">${esc}</span>`;
        default:        return esc;
      }
    })
    .join('');
}

const highlighted = queries.map((q) => ({
  ...q,
  html: highlightSQL(q.sql),
}));
---

<div class="sql-playground">
  <div class="sql-playground-header">
    <div class="sql-playground-title">
      <span class="sql-playground-dot red"></span>
      <span class="sql-playground-dot yellow"></span>
      <span class="sql-playground-dot green"></span>
      <span class="sql-playground-name">TensorDB SQL</span>
    </div>
    <select class="sql-query-select" id="sql-query-select">
      {queries.map((q, i) => (
        <option value={i.toString()}>{q.label}</option>
      ))}
    </select>
  </div>

  {highlighted.map((q, i) => (
    <div class={`sql-query-panel ${i === 0 ? 'active' : ''}`} data-query-idx={i.toString()}>
      <div class="sql-editor">
        <pre><code set:html={q.html} /></pre>
      </div>
      <div class="sql-results">
        <div class="sql-results-header">
          <span class="sql-results-label">Results</span>
          <span class="sql-results-badge">{q.result.rows.length} row{q.result.rows.length !== 1 ? 's' : ''}</span>
        </div>
        <div class="sql-results-table-wrap">
          <table>
            <thead>
              <tr>
                {q.result.columns.map(col => <th>{col}</th>)}
              </tr>
            </thead>
            <tbody>
              {q.result.rows.map(row => (
                <tr>
                  {row.map(cell => <td>{cell}</td>)}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  ))}
</div>

<script>
  const select = document.getElementById('sql-query-select') as HTMLSelectElement;
  if (select) {
    select.addEventListener('change', () => {
      const panels = document.querySelectorAll('.sql-query-panel');
      panels.forEach(p => p.classList.remove('active'));
      const target = document.querySelector(`[data-query-idx="${select.value}"]`);
      if (target) target.classList.add('active');
    });
  }
</script>

<style>
  .sql-query-panel {
    display: none;
  }
  .sql-query-panel.active {
    display: block;
  }
  .sql-playground-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .sql-playground-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
  }
  .sql-playground-dot.red { background: #ef4444; }
  .sql-playground-dot.yellow { background: #f59e0b; }
  .sql-playground-dot.green { background: #10b981; }
  .sql-playground-name {
    font-weight: 600;
    font-size: 0.9rem;
    margin-left: 0.5rem;
    color: var(--tensor-text);
  }
  .sql-editor {
    padding: 1.5rem;
    background: var(--tensor-dark);
  }
  .sql-editor pre {
    margin: 0;
    font-family: var(--sl-font-mono);
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--tensor-text);
    background: none !important;
    border: none !important;
    padding: 0 !important;
  }
  .sql-editor code {
    background: none !important;
    padding: 0;
    font-size: inherit;
    border: none !important;
  }
  .sql-results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }
  .sql-results-label {
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--tensor-text-muted);
  }
  .sql-results-badge {
    font-size: 0.75rem;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    background: rgba(59, 130, 246, 0.15);
    color: var(--tensor-blue);
  }
  .sql-results-table-wrap {
    overflow-x: auto;
  }
  .sql-results table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }
  .sql-results th {
    text-align: left;
    padding: 0.5rem 1rem;
    border-bottom: 2px solid var(--tensor-blue);
    font-weight: 600;
    color: var(--tensor-blue);
    font-size: 0.8rem;
    white-space: nowrap;
  }
  .sql-results td {
    padding: 0.5rem 1rem;
    border-bottom: 1px solid var(--tensor-card-border);
    color: var(--tensor-text);
    font-family: var(--sl-font-mono);
    font-size: 0.8rem;
  }
</style>
